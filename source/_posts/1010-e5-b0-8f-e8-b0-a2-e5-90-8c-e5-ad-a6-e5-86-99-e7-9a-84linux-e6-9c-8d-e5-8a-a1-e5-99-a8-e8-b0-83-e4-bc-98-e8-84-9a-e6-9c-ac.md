---
title: 小谢同学写的linux 服务器调优脚本
tags:
  - linux
  - TCP
url: 1010.html
id: 1010
categories:
  - linux server
date: 2017-02-23 13:50:45
---

modify_sysctl.py
----------------

\[code lang=python\] # -*- coding: utf-8 -*- ''' Created on 2015-1-21 @author: xie ''' ''' net.ipv4.tcp\_rmem = 4096 87380 16777216 net.ipv4.tcp\_wmem = 4096 65536 16777216 net.core.wmem\_default = 8388608 net.core.rmem\_default = 8388608 net.core.rmem\_max = 16777216 net.core.wmem\_max = 16777216 net.core.netdev\_max\_backlog = 30000 net.core.somaxconn = 65535 net.ipv4.tcp\_max\_syn\_backlog = 262144 net.ipv4.tcp\_max\_tw\_buckets = 6000 net.ipv4.tcp\_tw\_recycle = 1 net.ipv4.tcp\_tw\_reuse = 1 net.ipv4.tcp\_fin\_timeout = 30 net.ipv4.ip\_local\_port\_range = 9000 65535 net.ipv4.tcp\_syncookies = 1 net.ipv4.tcp\_max\_orphans = 262144 net.ipv4.tcp\_synack\_retries = 2 net.ipv4.tcp\_syn\_retries = 2 ''' import re,commands SYSCTL\_CONFIG = '/etc/sysctl.conf' class SetSysctl(): def \_\_init__(self): self.\_sysctls = \[\] self.\_sysctls.append('net.ipv4.tcp\_rmem = 4096 87380 16777216') self.\_sysctls.append('net.ipv4.tcp\_wmem = 4096 65536 16777216') self.\_sysctls.append('net.core.wmem\_default = 8388608') self.\_sysctls.append('net.core.rmem\_default = 8388608') self.\_sysctls.append('net.core.rmem\_max = 16777216') self.\_sysctls.append('net.core.wmem\_max = 16777216') self.\_sysctls.append('net.core.netdev\_max\_backlog = 30000') self.\_sysctls.append('net.core.somaxconn = 65535') self.\_sysctls.append('net.ipv4.tcp\_max\_syn\_backlog = 262144') self.\_sysctls.append('net.ipv4.tcp\_max\_tw\_buckets = 6000') self.\_sysctls.append('net.ipv4.tcp\_tw\_recycle = 1') self.\_sysctls.append('net.ipv4.tcp\_tw\_reuse = 1') self.\_sysctls.append('net.ipv4.tcp\_fin\_timeout = 30') self.\_sysctls.append('net.ipv4.ip\_local\_port\_range = 9000 65535') self.\_sysctls.append('net.ipv4.tcp\_syncookies = 1') self.\_sysctls.append('net.ipv4.tcp\_max\_orphans = 262144') self.\_sysctls.append('net.ipv4.tcp\_synack\_retries = 2') self.\_sysctls.append('net.ipv4.tcp\_syn\_retries = 2') self.\_sysctls.append('') self.\_sysctls.append('kernel.core\_pattern = /home/core/core.%p') self.\_create\_core() self.\_read\_sysctl() self.\_write\_sysctl() def \_read\_sysctl(self): network = open(SYSCTL\_CONFIG, 'r') self.\_lines = \[\] for line in network: flag = False for sysctl in self.\_sysctls: regex\_str = sysctl.split('=')\[0\] ma = re.match(r'^'+regex\_str+'.*?', line, re.IGNORECASE) if ma: flag = True break; if not flag: self.\_lines.append(line) network.close() def \_write\_sysctl(self): sysctls = open(SYSCTL\_CONFIG, 'w') self.\_lines.extend(self.\_sysctls) sysctls.write('\\n'.join(self.\_lines)) sysctls.close() commands.getoutput('sysctl -p') def \_create\_core(self): commands.getoutput('mkdir /home/core') commands.getoutput('chown -R mc-ops:mc-ops /home/core') if \_\_name\_\_ == '\_\_main\_\_': SetSysctl() \[/code\]

modify_ulimit.py
----------------

\[code lang=python\] <br /># -*- coding: utf-8 -*- #!/usr/bin/env python2.7 ''' Created on 2013-5-6 @author: xie ''' import commands, re,os LIMIT\_CONF = '/etc/security/limits.conf' SOFT\_NOFILE = '* soft nofile 1048576\\n' HAND\_NOFILE = '* hard nofile 1048576\\n' SOFT\_NPROC = '* soft nproc 1048576\\n' HAND\_NPROC = '* hard nproc 1048576\\n' PROFILE\_CONF = '/etc/profile' ULIMIT\_NOFILE = 'ulimit -HSn 1048576\\n' NPROC\_LIMIT\_CONF = '/etc/security/limits.d/90-nproc.conf' def modify\_ulimit(): lines = \[\] ulimit = open(LIMIT\_CONF, 'r') for line in ulimit: ma = re.match(r'.*?soft *?', line, re.IGNORECASE) mx = re.match(r'.*?hard *?', line, re.IGNORECASE) if ma or mx: continue lines.append(line) ulimit.close() lines.append(SOFT\_NOFILE) lines.append(HAND\_NOFILE) lines.append(SOFT\_NPROC) lines.append(HAND\_NPROC) ulimit = open(LIMIT\_CONF, 'w') ulimit.write(''.join(lines)) ulimit.close() commands.getoutput('ulimit -HSn 1048576') if not isCentos7(): modify\_nproc\_ulimit() writeProfile() def modify\_nproc\_ulimit(): lines = \[\] if os.path.exists(NPROC\_LIMIT\_CONF): ulimit = open(NPROC\_LIMIT\_CONF, 'r') for line in ulimit: ma = re.match(r'.*?soft *?', line, re.IGNORECASE) if ma: continue lines.append(line) ulimit.close() lines.append('* soft nproc 1048576\\n') lines.append('root soft nproc unlimited\\n') ulimit = open(NPROC\_LIMIT\_CONF, 'w') ulimit.write(''.join(lines)) ulimit.close() def writeProfile(): lines = \[\] flag = False profile = open(PROFILE\_CONF, 'r') for line in profile: ma = re.match(r'.*?ulimit -HSn 1048576.*', line, re.IGNORECASE) if ma is not None: flag = True lines.append(line) profile.close() if flag == False: lines.append(ULIMIT\_NOFILE) profile = open(PROFILE\_CONF, 'w') profile.write(''.join(lines)) profile.close() def isCentos7(): mage = commands.getoutput('cat /etc/redhat-release').split('\\n') #CentOS Linux release 7.1.1503 (Core) #CentOS release 6.6 (Final) cP = re.compile(r'.*\\s+(?P\\d+).*', re.IGNORECASE) for mess in mage: ma = cP.match(mess) if ma is not None: ip = ma.group('release') if ip == '7': return True return False pass if \_\_name__ == '\_\_main\_\_': modify_ulimit() \[/code\]